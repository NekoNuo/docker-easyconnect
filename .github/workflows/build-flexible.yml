name: Flexible Build - EasyConnect & aTrust

on:
  push:
    branches: [ main, master ]
    paths:
      - 'Dockerfile'
      - 'docker-root/**'
      - 'build-scripts/**'
      - 'build-args/**'
      - '.github/workflows/build-flexible.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      product_type:
        description: 'Product to build'
        required: true
        default: 'aTrust'
        type: choice
        options:
          - 'aTrust'
          - 'EasyConnect'
      version:
        description: 'Version to build'
        required: true
        default: 'latest'
        type: choice
        options:
          - 'latest'
          - '2.5.16.20'
          - '2.4.10.50'
          - '2.3.10_sp4'
          - '2.3.10_sp3'
          - '2.3.10.65'
          - '2.2.16'
          - '7.6.7'
          - '7.6.3'
      version_type:
        description: 'Version type (VNC support level)'
        required: true
        default: 'vnc'
        type: choice
        options:
          - 'vnc'
          - 'vncless'
          - 'cli'
      architecture:
        description: 'Architecture to build'
        required: true
        default: 'amd64'
        type: choice
        options:
          - 'amd64'
          - 'arm64'
          - 'i386'
          - 'mips64le'
          - 'all'
      push_to_registry:
        description: 'Push to Docker registry'
        required: false
        default: true
        type: boolean
      run_tests:
        description: 'Run tests after build'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: docker.io
  BASE_IMAGE_NAME: gys619/docker-easyconnect

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setup-matrix.outputs.matrix }}
      image_name: ${{ steps.setup-vars.outputs.image_name }}
      product_type: ${{ steps.setup-vars.outputs.product_type }}
      version: ${{ steps.setup-vars.outputs.version }}
      version_type: ${{ steps.setup-vars.outputs.version_type }}
      vpn_type: ${{ steps.setup-vars.outputs.vpn_type }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup variables
      id: setup-vars
      run: |
        # 设置产品类型 (默认为 aTrust)
        PRODUCT_INPUT="${{ github.event.inputs.product_type }}"
        if [ "$PRODUCT_INPUT" = "EasyConnect" ]; then
          PRODUCT_TYPE="EASYCONNECT"
          IMAGE_SUFFIX=""
        else
          # 默认为 aTrust
          PRODUCT_TYPE="ATRUST"
          IMAGE_SUFFIX="-atrust"
        fi

        # 设置版本 (默认为对应产品的最新版本)
        VERSION="${{ github.event.inputs.version }}"
        if [ -z "$VERSION" ] || [ "$VERSION" = "latest" ]; then
          if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
            VERSION="2.4.10.50"  # aTrust 最新版本
          else
            VERSION="7.6.7"      # EasyConnect 最新版本
          fi
        fi

        # 设置版本类型 (默认为 vnc)
        VERSION_TYPE="${{ github.event.inputs.version_type }}"
        if [ -z "$VERSION_TYPE" ]; then
          VERSION_TYPE="vnc"  # 默认为带 VNC 的版本
        fi

        # 根据产品类型和版本类型设置 VPN_TYPE
        if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
          VPN_TYPE="ATRUST"
        else
          # EasyConnect 根据版本类型设置
          case "$VERSION_TYPE" in
            "cli")
              VPN_TYPE="EC_CLI"
              ;;
            "vncless")
              VPN_TYPE="EC_GUI"  # 无 VNC 但仍是 GUI 版本
              ;;
            "vnc"|*)
              VPN_TYPE="EC_GUI"  # 默认 GUI 版本
              ;;
          esac
        fi

        # 设置镜像名称 (根据版本类型调整后缀)
        if [ "$VERSION_TYPE" = "cli" ]; then
          IMAGE_NAME="${{ env.BASE_IMAGE_NAME }}${IMAGE_SUFFIX}-cli"
        elif [ "$VERSION_TYPE" = "vncless" ]; then
          IMAGE_NAME="${{ env.BASE_IMAGE_NAME }}${IMAGE_SUFFIX}-vncless"
        else
          IMAGE_NAME="${{ env.BASE_IMAGE_NAME }}${IMAGE_SUFFIX}"
        fi

        echo "Selected product: $PRODUCT_TYPE"
        echo "Selected version: $VERSION"
        echo "Selected version type: $VERSION_TYPE"
        echo "VPN type: $VPN_TYPE"
        echo "Image name: $IMAGE_NAME"

        echo "product_type=$PRODUCT_TYPE" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
        echo "vpn_type=$VPN_TYPE" >> $GITHUB_OUTPUT
        echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

    - name: Setup build matrix
      id: setup-matrix
      run: |
        ARCHITECTURE="${{ github.event.inputs.architecture }}"

        # 如果是 workflow_dispatch 但没有指定架构，使用默认值
        if [ -z "$ARCHITECTURE" ]; then
          ARCHITECTURE="amd64"
        fi

        echo "Selected architecture: $ARCHITECTURE"

        if [ "$ARCHITECTURE" = "all" ]; then
          # 检查支持的架构
          PRODUCT_TYPE="${{ steps.setup-vars.outputs.product_type }}"
          VERSION="${{ steps.setup-vars.outputs.version }}"

          echo "Checking supported architectures for $PRODUCT_TYPE version $VERSION"

          ARCHS=()
          for arch in amd64 arm64 i386 mips64le; do
            # 检查构建参数文件是否存在
            if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
              BUILD_ARGS_FILE="build-args/atrust-${VERSION}-${arch}.txt"
              FALLBACK_FILE="build-args/atrust-${arch}.txt"
            else
              BUILD_ARGS_FILE="build-args/${VERSION}-${arch}.txt"
              FALLBACK_FILE="build-args/easyconnect-${arch}.txt"
            fi

            echo "Checking files: $BUILD_ARGS_FILE, $FALLBACK_FILE"

            if [ -f "$BUILD_ARGS_FILE" ] || [ -f "$FALLBACK_FILE" ]; then
              ARCHS+=("$arch")
              echo "Added architecture: $arch"
            else
              echo "Skipped architecture: $arch (no build args file found)"
            fi
          done

          # 确保至少有一个架构
          if [ ${#ARCHS[@]} -eq 0 ]; then
            echo "No supported architectures found, using amd64 as fallback"
            ARCHS=("amd64")
          fi

          # 生成 matrix JSON
          MATRIX_JSON=$(printf '%s\n' "${ARCHS[@]}" | jq -R . | jq -s '{architecture: .}')
        else
          # 验证单个架构是否有效
          case "$ARCHITECTURE" in
            amd64|arm64|i386|mips64le)
              MATRIX_JSON="{\"architecture\": [\"$ARCHITECTURE\"]}"
              ;;
            *)
              echo "Error: Invalid architecture '$ARCHITECTURE'. Supported: amd64, arm64, i386, mips64le, all"
              exit 1
              ;;
          esac
        fi

        echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "Generated matrix: $MATRIX_JSON"

  build:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
      fail-fast: false
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false')
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Setup platform mapping
      id: platform
      run: |
        ARCH="${{ matrix.architecture }}"
        echo "Processing architecture: $ARCH"

        if [ -z "$ARCH" ]; then
          echo "Error: Architecture is empty"
          exit 1
        fi

        case "$ARCH" in
          amd64)    echo "platform=linux/amd64" >> $GITHUB_OUTPUT ;;
          arm64)    echo "platform=linux/arm64" >> $GITHUB_OUTPUT ;;
          i386)     echo "platform=linux/386" >> $GITHUB_OUTPUT ;;
          mips64le) echo "platform=linux/mips64le" >> $GITHUB_OUTPUT ;;
          *)
            echo "Error: Unsupported architecture: $ARCH"
            exit 1
            ;;
        esac

        echo "Set platform: $(cat $GITHUB_OUTPUT | grep platform)"

    - name: Get build arguments
      id: build-args
      run: |
        PRODUCT_TYPE="${{ needs.setup.outputs.product_type }}"
        VERSION="${{ needs.setup.outputs.version }}"
        VERSION_TYPE="${{ needs.setup.outputs.version_type }}"
        VPN_TYPE="${{ needs.setup.outputs.vpn_type }}"
        ARCH="${{ matrix.architecture }}"

        echo "Build configuration:"
        echo "  Product: $PRODUCT_TYPE"
        echo "  Version: $VERSION"
        echo "  Version Type: $VERSION_TYPE"
        echo "  VPN Type: $VPN_TYPE"
        echo "  Architecture: $ARCH"

        # 尝试查找构建参数文件
        if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
          BUILD_ARGS_FILE="build-args/atrust-${VERSION}-${ARCH}.txt"
          FALLBACK_FILE="build-args/atrust-${ARCH}.txt"
        else
          BUILD_ARGS_FILE="build-args/${VERSION}-${ARCH}.txt"
          FALLBACK_FILE="build-args/easyconnect-${ARCH}.txt"
        fi

        if [ -f "$BUILD_ARGS_FILE" ]; then
          BUILD_ARGS=$(cat "$BUILD_ARGS_FILE" | tr '\n' ' ')
          echo "Using build args from: $BUILD_ARGS_FILE"
        elif [ -f "$FALLBACK_FILE" ]; then
          BUILD_ARGS=$(cat "$FALLBACK_FILE" | tr '\n' ' ')
          echo "Using build args from: $FALLBACK_FILE"
        else
          echo "No build args file found, using defaults"
          BUILD_ARGS=""
        fi

        # 提取 VPN_URL
        if [ -n "$BUILD_ARGS" ]; then
          VPN_URL=$(echo "$BUILD_ARGS" | grep -o 'VPN_URL=[^ ]*' | cut -d'=' -f2)
        fi

        # 设置默认值
        if [ -z "$VPN_URL" ]; then
          if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
            VPN_URL="https://atrustcdn.sangfor.com/standard/linux/2.4.10.50/uos/${ARCH}/aTrustInstaller_${ARCH}.deb"
          else
            VPN_URL="https://download.sangfor.com.cn/download/product/sslvpn/pkg/linux_767/EasyConnect_x64_7_6_7_3.deb"
          fi
        fi

        echo "vpn_url=$VPN_URL" >> $GITHUB_OUTPUT
        echo "vpn_type=$VPN_TYPE" >> $GITHUB_OUTPUT
        echo "Found VPN_URL: $VPN_URL"
        echo "Using VPN_TYPE: $VPN_TYPE"

    - name: Setup product tag
      id: product-tag
      run: |
        PRODUCT_TYPE="${{ needs.setup.outputs.product_type }}"
        VERSION_TYPE="${{ needs.setup.outputs.version_type }}"
        VERSION="${{ needs.setup.outputs.version }}"
        ARCH="${{ matrix.architecture }}"

        # 根据产品类型和版本类型设置标签前缀
        if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
          PRODUCT_PREFIX="atrust"
        else
          # EasyConnect 根据版本类型设置前缀
          case "$VERSION_TYPE" in
            "cli")
              PRODUCT_PREFIX="easyconnect-cli"
              ;;
            "vncless")
              PRODUCT_PREFIX="easyconnect-vncless"
              ;;
            "vnc"|*)
              PRODUCT_PREFIX="easyconnect"
              ;;
          esac
        fi

        echo "product_prefix=$PRODUCT_PREFIX" >> $GITHUB_OUTPUT
        echo "Product prefix: $PRODUCT_PREFIX (Product: $PRODUCT_TYPE, Type: $VERSION_TYPE)"

    - name: Setup latest tag condition
      id: latest-tag
      run: |
        # 简化 latest 标签逻辑：每次构建都推送 latest 标签
        ENABLE_LATEST="true"

        echo "enable_latest=$ENABLE_LATEST" >> $GITHUB_OUTPUT
        echo "Latest tag enabled: $ENABLE_LATEST (Always push latest tag)"

    - name: Setup version type tags
      id: version-type-tags
      run: |
        VERSION_TYPE="${{ needs.setup.outputs.version_type }}"

        # 为所有版本类型生成标签，包括 VNC
        TYPE_SUFFIX="-${VERSION_TYPE}"
        TYPE_PREFIX="${VERSION_TYPE}-"

        echo "type_suffix=$TYPE_SUFFIX" >> $GITHUB_OUTPUT
        echo "type_prefix=$TYPE_PREFIX" >> $GITHUB_OUTPUT
        echo "Version type tags: suffix='$TYPE_SUFFIX', prefix='$TYPE_PREFIX' (Type: $VERSION_TYPE)"

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}
        tags: |
          type=raw,value=latest,enable=${{ steps.latest-tag.outputs.enable_latest == 'true' }}
          type=raw,value=${{ steps.product-tag.outputs.product_prefix }}-${{ steps.version-type-tags.outputs.type_prefix }}${{ needs.setup.outputs.version }}-${{ matrix.architecture }},enable={{is_default_branch}}

    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: ${{ steps.platform.outputs.platform }}
        push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          VPN_TYPE=${{ steps.build-args.outputs.vpn_type }}
          EC_HOST=${{ matrix.architecture }}
          MIRROR_URL=http://deb.debian.org/debian/
          VPN_URL=${{ steps.build-args.outputs.vpn_url }}
          BUILD_ENV=actions
        cache-from: type=gha,scope=${{ matrix.architecture }}
        cache-to: type=gha,mode=max,scope=${{ matrix.architecture }}

    - name: Test image
      if: success() && (github.event.inputs.run_tests != 'false')
      run: |
        echo "Testing built image for ${{ matrix.architecture }}..."
        IMAGE_TAG="${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.version }}-${{ matrix.architecture }}"
        
        # 基础测试
        docker run --rm $IMAGE_TAG --version || true
        
        # VNC 相关测试
        if [ "${{ steps.build-args.outputs.vpn_type }}" = "ATRUST" ]; then
          docker run --rm $IMAGE_TAG vnc-lowres-optimizer.sh status || true
        fi

    - name: Security scan
      if: success() && (github.event.inputs.run_tests != 'false')
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${{ needs.setup.outputs.version }}-${{ matrix.architecture }}
        format: 'sarif'
        output: 'trivy-results-${{ matrix.architecture }}.sarif'
      continue-on-error: true

    - name: Upload security scan results
      if: success() && (github.event.inputs.run_tests != 'false')
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results-${{ matrix.architecture }}.sarif'
      continue-on-error: true

  summary:
    needs: [setup, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Generate build summary
      run: |
        # 设置产品前缀
        PRODUCT_TYPE="${{ needs.setup.outputs.product_type }}"
        if [ "$PRODUCT_TYPE" = "ATRUST" ]; then
          PRODUCT_PREFIX="atrust"
          DISPLAY_PRODUCT="aTrust"
        else
          PRODUCT_PREFIX="easyconnect"
          DISPLAY_PRODUCT="EasyConnect"
        fi

        echo "## 🚀 Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Product**: $DISPLAY_PRODUCT" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture**: ${{ github.event.inputs.architecture || 'amd64' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Usage Example" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "docker run --rm --device /dev/net/tun --cap-add NET_ADMIN -ti \\" >> $GITHUB_STEP_SUMMARY
        echo "  -e PASSWORD=your_password \\" >> $GITHUB_STEP_SUMMARY
        echo "  -e VNC_AUTO_LOWRES=1 \\" >> $GITHUB_STEP_SUMMARY
        echo "  -p 127.0.0.1:5901:5901 \\" >> $GITHUB_STEP_SUMMARY
        echo "  -p 127.0.0.1:1080:1080 \\" >> $GITHUB_STEP_SUMMARY
        echo "  -p 127.0.0.1:8888:8888 \\" >> $GITHUB_STEP_SUMMARY
        echo "  --sysctl net.ipv4.conf.default.route_localnet=1 \\" >> $GITHUB_STEP_SUMMARY
        echo "  ${{ env.REGISTRY }}/${{ needs.setup.outputs.image_name }}:${PRODUCT_PREFIX}-${{ needs.setup.outputs.version }}-amd64" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
